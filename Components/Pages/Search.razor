@page "/search"

@using Journal.Repository
@using Journal.Services
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject JournalRepository JournalRepository
@inject IDialogService DialogService
@inject IPdfExportService PdfExportService



<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">

    @if (!AuthService.IsAuthenticated)
    {
        <MudAlert Severity="Severity.Warning">Please log in to search your entries.</MudAlert>
        return;
    }

    <!-- Header -->
    <MudText Typo="Typo.h3" GutterBottom Class="mb-6">
        üîç Search Your Journals
    </MudText>

    <MudGrid Spacing="4">

        <!-- Search Panel -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="pa-4 mb-4">
                
                <!-- Search Bar -->
                <MudTextField @bind-Value="searchQuery"
                             Label="Search entries..."
                             Variant="Variant.Outlined"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             OnKeyDown="HandleKeyPress"
                             Immediate="false"
                             FullWidth
                             Class="mb-3" />

                <!-- Search Filters -->
                <MudExpansionPanels>
                    <MudExpansionPanel Text="Advanced Filters" Dense>
                        <MudGrid Spacing="2" Class="mt-2">
                            
                            <!-- Date Range -->
                            <MudItem xs="12" sm="6">
                                <MudDateRangePicker Label="Date Range"
                                                   @bind-DateRange="dateRange"
                                                   Variant="Variant.Outlined"
                                                   Dense />
                            </MudItem>

                            <!-- Mood Filter -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="selectedMood"
                                          Label="Mood"
                                          Variant="Variant.Outlined"
                                          Clearable
                                          Dense>
                                    <MudSelectItem Value="@("")">All Moods</MudSelectItem>
                                    <MudSelectItem Value="@("üòä Happy")">üòä Happy</MudSelectItem>
                                    <MudSelectItem Value="@("üòî Sad")">üòî Sad</MudSelectItem>
                                    <MudSelectItem Value="@("üòå Peaceful")">üòå Peaceful</MudSelectItem>
                                    <MudSelectItem Value="@("üò§ Frustrated")">üò§ Frustrated</MudSelectItem>
                                    <MudSelectItem Value="@("ü§ó Grateful")">ü§ó Grateful</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <!-- Word Count Filter -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="wordCountFilter"
                                          Label="Word Count"
                                          Variant="Variant.Outlined"
                                          Dense>
                                    <MudSelectItem Value="@("all")">All Lengths</MudSelectItem>
                                    <MudSelectItem Value="@("short")">Short (&lt; 200 words)</MudSelectItem>
                                    <MudSelectItem Value="@("medium")">Medium (200-500 words)</MudSelectItem>
                                    <MudSelectItem Value="@("long")">Long (&gt; 500 words)</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <!-- Sort By -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="sortBy"
                                          Label="Sort By"
                                          Variant="Variant.Outlined"
                                          Dense>
                                    <MudSelectItem Value="@("date-desc")">Newest First</MudSelectItem>
                                    <MudSelectItem Value="@("date-asc")">Oldest First</MudSelectItem>
                                    <MudSelectItem Value="@("relevance")">Most Relevant</MudSelectItem>
                                    <MudSelectItem Value="@("word-count")">Word Count</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                        </MudGrid>

                        <MudStack Row Spacing="2" Class="mt-3">
                            <MudButton Color="Color.Primary"
                                      Variant="Variant.Filled"
                                      StartIcon="@Icons.Material.Filled.Search"
                                      OnClick="PerformSearch">
                                Search
                            </MudButton>
                            <MudButton Color="Color.Default"
                                      Variant="Variant.Outlined"
                                      StartIcon="@Icons.Material.Filled.Clear"
                                      OnClick="ClearFilters">
                                Clear Filters
                            </MudButton>
                        </MudStack>
                    </MudExpansionPanel>
                </MudExpansionPanels>

            </MudPaper>

            <!-- Results Section -->
            @if (isSearching)
            {
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate />
                    <MudText Typo="Typo.body1" Class="mt-4">Searching...</MudText>
                </MudPaper>
            }
            else if (hasSearched && searchResults.Count == 0)
            {
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">No Results Found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Try adjusting your search terms or filters
                    </MudText>
                </MudPaper>
            }
            else if (hasSearched)
            {
                <MudPaper Elevation="2" Class="pa-3 mb-3">
                    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">
                            Found <strong>@searchResults.Count</strong> @(searchResults.Count == 1 ? "entry" : "entries")
                        </MudText>
                        <MudChipSet T="string">
                            <MudChip T="string" Size="Size.Small" 
                                    Icon="@Icons.Material.Filled.GridView"
                                    Variant="@(viewMode == "grid" ? Variant.Filled : Variant.Outlined)"
                                    Color="Color.Primary"
                                    OnClick="@(() => viewMode = "grid")">
                                Grid
                            </MudChip>
                            <MudChip T="string" Size="Size.Small" 
                                    Icon="@Icons.Material.Filled.ViewList"
                                    Variant="@(viewMode == "list" ? Variant.Filled : Variant.Outlined)"
                                    Color="Color.Primary"
                                    OnClick="@(() => viewMode = "list")">
                                List
                            </MudChip>
                        </MudChipSet>
                    </MudStack>
                </MudPaper>

                @if (viewMode == "grid")
                {
                    <MudGrid Spacing="3">
                        @foreach (var entry in searchResults)
                        {
                            <MudItem xs="12" sm="6">
                                <MudCard Elevation="2" Class="search-result-card">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                                <div>
                                                    <MudText Typo="Typo.subtitle1">@entry.Date.ToString("MMM dd, yyyy")</MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @entry.WordCount words ‚Ä¢ @entry.Date.ToString("dddd")
                                                    </MudText>
                                                </div>
                                                <MudChip T="string" Size="Size.Small" Color="@GetMoodColor(entry.Mood)">
                                                    @entry.Mood
                                                </MudChip>
                                            </MudStack>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudText Typo="Typo.body2" Class="search-preview">
                                            @HighlightText(entry.Content)
                                        </MudText>
                                        
                                        @if (entry.Tags.Any())
                                        {
                                            <MudStack Row Spacing="1" Wrap="Wrap.Wrap" Class="mt-3">
                                                @foreach (var tag in entry.Tags.Take(3))
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                        @tag
                                                    </MudChip>
                                                }
                                            </MudStack>
                                        }
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Color="Color.Primary"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Visibility"
                                                  OnClick="@(() => ViewEntry(entry))">
                                            View
                                        </MudButton>
                                        <MudButton Color="Color.Secondary"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Edit"
                                                  OnClick="@(() => EditEntry(entry))">
                                            Edit
                                        </MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <MudStack Spacing="2">
                        @foreach (var entry in searchResults)
                        {
                            <MudPaper Elevation="2" Class="pa-4 search-result-list">
                                <MudStack Spacing="2">
                                    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <div>
                                            <MudText Typo="Typo.h6">@entry.Date.ToString("MMMM dd, yyyy")</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @entry.WordCount words ‚Ä¢ @entry.Date.ToString("dddd")
                                            </MudText>
                                        </div>
                                        <MudChip T="string" Color="@GetMoodColor(entry.Mood)">@entry.Mood</MudChip>
                                    </MudStack>

                                    <MudDivider />

                                    <MudText Typo="Typo.body2" Class="search-preview-list">
                                        @HighlightText(entry.Content)
                                    </MudText>

                                    @if (entry.Tags.Any())
                                    {
                                        <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                            @foreach (var tag in entry.Tags)
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tag</MudChip>
                                            }
                                        </MudStack>
                                    }

                                    <MudStack Row Spacing="2">
                                        <MudButton Color="Color.Primary"
                                                  Variant="Variant.Filled"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Visibility"
                                                  OnClick="@(() => ViewEntry(entry))">
                                            View Full Entry
                                        </MudButton>
                                        <MudButton Color="Color.Secondary"
                                                  Variant="Variant.Outlined"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Edit"
                                                  OnClick="@(() => EditEntry(entry))">
                                            Edit
                                        </MudButton>
                                        <MudButton Color="Color.Default"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Share"
                                                  OnClick="@(() => Snackbar.Add("Share feature coming soon!", Severity.Info))">
                                            Share
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
            }
            else
            {
                <!-- Empty State -->
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Start Searching</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Enter keywords to find your journal entries
                    </MudText>
                </MudPaper>
            }
            <!-- All Journals Section -->
    <MudDivider Class="my-6" />

    <MudText Typo="Typo.h5" GutterBottom Class="mb-4">
        üìñ All Journal Entries
    </MudText>

    @if (isLoadingJournals)
    {
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate />
            <MudText Class="mt-3">Loading journals...</MudText>
        </MudPaper>
    }
    else if (!allJournals.Any())
    {
        <MudPaper Elevation="2" Class="pa-6 text-center">
            <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-3">No journals yet</MudText>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-3" Href="/journal">
                Write Your First Entry
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudTable Items="@PagedJournals" Hover Striped Elevation="2">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Mood</MudTh>
                <MudTh>Preview</MudTh>
                <MudTh Style="width: 120px;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Date">
                    <MudText Typo="Typo.body2">@context.Date.ToString("MMM dd, yyyy")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Date.ToString("dddd")</MudText>
                </MudTd>
                <MudTd DataLabel="Mood">
                    @if (!string.IsNullOrEmpty(context.PrimaryMood))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetMoodColor(context.PrimaryMood)">
                            @context.PrimaryMood
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Preview">
                    <MudText Typo="Typo.body2" Style="max-width: 300px;" Class="text-truncate">
                        @context.Title
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                    Size="Size.Small"
                                    Color="Color.Primary"
                                    OnClick="@(() => NavigationManager.NavigateTo($"/journal/view/{context.Id}"))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Secondary"
                                   OnClick="@(() => EditJournal(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>

        @if (totalPages > 1)
        {
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Showing @((currentPage - 1) * pageSize + 1)‚Äì@Math.Min(currentPage * pageSize, totalJournals) of @totalJournals
                </MudText>
                <MudPagination Count="@totalPages" Selected="@currentPage" SelectedChanged="OnPageChanged"
                               Color="Color.Primary" Variant="Variant.Filled" ShowFirstButton ShowLastButton />
            </MudStack>
        }
    }
        </MudItem>

        <!-- Sidebar -->
        <MudItem xs="12" md="4">
            <MudStack Spacing="4">
                <!-- Export -->
               <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">üñ®Ô∏è Quick Export</MudText>
    
                <MudStack Spacing="3">
                    <!-- Date Range Selection -->
                    <MudDatePicker Label="Start Date"
                                  @bind-Date="exportStartDate"
                                  Variant="Variant.Outlined"
                                  Dense />
                    
                    <MudDatePicker Label="End Date"
                                  @bind-Date="exportEndDate"
                                  Variant="Variant.Outlined"
                                  Dense />
                    
                    <MudDivider />
        
        <!-- Export Format Buttons -->
        <MudButton Variant="Variant.Filled"
                   Color="Color.Error"
                   FullWidth
                   StartIcon="@Icons.Material.Filled.PictureAsPdf"
                   OnClick="ExportToPdf"
                   Disabled="@(!exportStartDate.HasValue || !exportEndDate.HasValue)">
            Export as PDF
        </MudButton>
        
        
        
        
                </MudStack>
            </MudPaper>
                            
                <!-- Quick Filters -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">‚ö° Quick Filters</MudText>
                    
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Outlined"
                                   FullWidth
                                   StartIcon="@Icons.Material.Filled.Today"
                                   OnClick="@(() => QuickFilter("today"))">
                            Today's Entry
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   FullWidth
                                   StartIcon="@Icons.Material.Filled.DateRange"
                                   OnClick="@(() => QuickFilter("week"))">
                            This Week
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   FullWidth
                                   StartIcon="@Icons.Material.Filled.CalendarMonth"
                                   OnClick="@(() => QuickFilter("month"))">
                            This Month
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   FullWidth
                                   StartIcon="@Icons.Material.Filled.Star"
                                   OnClick="@(() => QuickFilter("favorites"))">
                            Favorites
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Popular Tags -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üè∑Ô∏è Popular Tags</MudText>
                    
                    <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                        @foreach (var tag in GetPopularTags())
                        {
                            <MudChip T="string" Size="Size.Small"
                                    Variant="Variant.Outlined"
                                    Color="Color.Primary"
                                    OnClick="@(() => SearchByTag(tag.Name))">
                                @tag.Name (@tag.Count)
                            </MudChip>
                        }
                    </MudStack>
                </MudPaper>

                <!-- Recent Searches -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üïí Recent Searches</MudText>
                    
                    @if (recentSearches.Any())
                    {
                        <MudList T="string"  Dense Clickable>
                            @foreach (var search in recentSearches.Take(5))
                            {
                                <MudListItem T="string" Icon="@Icons.Material.Filled.History"
                                            OnClick="@(() => { searchQuery = search; PerformSearch(); })">
                                    @search
                                </MudListItem>
                            }
                        </MudList>
                        <MudButton Color="Color.Default"
                                  Variant="Variant.Text"
                                  Size="Size.Small"
                                  FullWidth
                                  OnClick="ClearHistory">
                            Clear History
                        </MudButton>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            No recent searches
                        </MudText>
                    }
                </MudPaper>

                <!-- Search Tips -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üí° Search Tips</MudText>
                    
                    <MudList T="string" Dense>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Use quotes for exact phrases: "happy moments"
                            </MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Search multiple words: work family balance
                            </MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Filter by date range for better results
                            </MudText>
                        </MudListItem>
                    </MudList>
                </MudPaper>

            </MudStack>
        </MudItem>

   </MudGrid>

    

</MudContainer>
