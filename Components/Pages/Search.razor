@page "/search"
@using Journal.Models
@using Journal.Services
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">

    @if (!AuthService.IsAuthenticated)
    {
        <MudAlert Severity="Severity.Warning">Please log in to search your entries.</MudAlert>
        return;
    }

    <!-- Header -->
    <MudText Typo="Typo.h3" GutterBottom Class="mb-6">
        üîç Search Your Journals
    </MudText>

    <MudGrid Spacing="4">

        <!-- Search Panel -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="pa-4 mb-4">
                
                <!-- Search Bar -->
                <MudTextField @bind-Value="searchQuery"
                             Label="Search entries..."
                             Variant="Variant.Outlined"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             OnKeyDown="HandleKeyPress"
                             Immediate="false"
                             FullWidth
                             Class="mb-3" />

                <!-- Search Filters -->
                <MudExpansionPanels>
                    <MudExpansionPanel Text="Advanced Filters" Dense>
                        <MudGrid Spacing="2" Class="mt-2">
                            
                            <!-- Date Range -->
                            <MudItem xs="12" sm="6">
                                <MudDateRangePicker Label="Date Range"
                                                   @bind-DateRange="dateRange"
                                                   Variant="Variant.Outlined"
                                                   Dense />
                            </MudItem>

                            <!-- Mood Filter -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="selectedMood"
                                          Label="Mood"
                                          Variant="Variant.Outlined"
                                          Clearable
                                          Dense>
                                    <MudSelectItem Value="@("")">All Moods</MudSelectItem>
                                    <MudSelectItem Value="@("üòä Happy")">üòä Happy</MudSelectItem>
                                    <MudSelectItem Value="@("üòî Sad")">üòî Sad</MudSelectItem>
                                    <MudSelectItem Value="@("üòå Peaceful")">üòå Peaceful</MudSelectItem>
                                    <MudSelectItem Value="@("üò§ Frustrated")">üò§ Frustrated</MudSelectItem>
                                    <MudSelectItem Value="@("ü§ó Grateful")">ü§ó Grateful</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <!-- Word Count Filter -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="wordCountFilter"
                                          Label="Word Count"
                                          Variant="Variant.Outlined"
                                          Dense>
                                    <MudSelectItem Value="@("all")">All Lengths</MudSelectItem>
                                    <MudSelectItem Value="@("short")">Short (&lt; 200 words)</MudSelectItem>
                                    <MudSelectItem Value="@("medium")">Medium (200-500 words)</MudSelectItem>
                                    <MudSelectItem Value="@("long")">Long (&gt; 500 words)</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <!-- Sort By -->
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="sortBy"
                                          Label="Sort By"
                                          Variant="Variant.Outlined"
                                          Dense>
                                    <MudSelectItem Value="@("date-desc")">Newest First</MudSelectItem>
                                    <MudSelectItem Value="@("date-asc")">Oldest First</MudSelectItem>
                                    <MudSelectItem Value="@("relevance")">Most Relevant</MudSelectItem>
                                    <MudSelectItem Value="@("word-count")">Word Count</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                        </MudGrid>

                        <MudStack Row Spacing="2" Class="mt-3">
                            <MudButton Color="Color.Primary"
                                      Variant="Variant.Filled"
                                      StartIcon="@Icons.Material.Filled.Search"
                                      OnClick="PerformSearch">
                                Search
                            </MudButton>
                            <MudButton Color="Color.Default"
                                      Variant="Variant.Outlined"
                                      StartIcon="@Icons.Material.Filled.Clear"
                                      OnClick="ClearFilters">
                                Clear Filters
                            </MudButton>
                        </MudStack>
                    </MudExpansionPanel>
                </MudExpansionPanels>

            </MudPaper>

            <!-- Results Section -->
            @if (isSearching)
            {
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate />
                    <MudText Typo="Typo.body1" Class="mt-4">Searching...</MudText>
                </MudPaper>
            }
            else if (hasSearched && searchResults.Count == 0)
            {
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">No Results Found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Try adjusting your search terms or filters
                    </MudText>
                </MudPaper>
            }
            else if (hasSearched)
            {
                <MudPaper Elevation="2" Class="pa-3 mb-3">
                    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">
                            Found <strong>@searchResults.Count</strong> @(searchResults.Count == 1 ? "entry" : "entries")
                        </MudText>
                        <MudChipSet T="string">
                            <MudChip T="string" Size="Size.Small" 
                                    Icon="@Icons.Material.Filled.GridView"
                                    Variant="@(viewMode == "grid" ? Variant.Filled : Variant.Outlined)"
                                    Color="Color.Primary"
                                    OnClick="@(() => viewMode = "grid")">
                                Grid
                            </MudChip>
                            <MudChip T="string" Size="Size.Small" 
                                    Icon="@Icons.Material.Filled.ViewList"
                                    Variant="@(viewMode == "list" ? Variant.Filled : Variant.Outlined)"
                                    Color="Color.Primary"
                                    OnClick="@(() => viewMode = "list")">
                                List
                            </MudChip>
                        </MudChipSet>
                    </MudStack>
                </MudPaper>

                @if (viewMode == "grid")
                {
                    <MudGrid Spacing="3">
                        @foreach (var entry in searchResults)
                        {
                            <MudItem xs="12" sm="6">
                                <MudCard Elevation="2" Class="search-result-card">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                                <div>
                                                    <MudText Typo="Typo.subtitle1">@entry.Date.ToString("MMM dd, yyyy")</MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @entry.WordCount words ‚Ä¢ @entry.Date.ToString("dddd")
                                                    </MudText>
                                                </div>
                                                <MudChip T="string" Size="Size.Small" Color="@GetMoodColor(entry.Mood)">
                                                    @entry.Mood
                                                </MudChip>
                                            </MudStack>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <MudText Typo="Typo.body2" Class="search-preview">
                                            @HighlightText(entry.Content)
                                        </MudText>
                                        
                                        @if (entry.Tags.Any())
                                        {
                                            <MudStack Row Spacing="1" Wrap="Wrap.Wrap" Class="mt-3">
                                                @foreach (var tag in entry.Tags.Take(3))
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                        @tag
                                                    </MudChip>
                                                }
                                            </MudStack>
                                        }
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Color="Color.Primary"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Visibility"
                                                  OnClick="@(() => ViewEntry(entry))">
                                            View
                                        </MudButton>
                                        <MudButton Color="Color.Secondary"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Edit"
                                                  OnClick="@(() => EditEntry(entry))">
                                            Edit
                                        </MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <MudStack Spacing="2">
                        @foreach (var entry in searchResults)
                        {
                            <MudPaper Elevation="2" Class="pa-4 search-result-list">
                                <MudStack Spacing="2">
                                    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <div>
                                            <MudText Typo="Typo.h6">@entry.Date.ToString("MMMM dd, yyyy")</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @entry.WordCount words ‚Ä¢ @entry.Date.ToString("dddd")
                                            </MudText>
                                        </div>
                                        <MudChip T="string" Color="@GetMoodColor(entry.Mood)">@entry.Mood</MudChip>
                                    </MudStack>

                                    <MudDivider />

                                    <MudText Typo="Typo.body2" Class="search-preview-list">
                                        @HighlightText(entry.Content)
                                    </MudText>

                                    @if (entry.Tags.Any())
                                    {
                                        <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                            @foreach (var tag in entry.Tags)
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tag</MudChip>
                                            }
                                        </MudStack>
                                    }

                                    <MudStack Row Spacing="2">
                                        <MudButton Color="Color.Primary"
                                                  Variant="Variant.Filled"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Visibility"
                                                  OnClick="@(() => ViewEntry(entry))">
                                            View Full Entry
                                        </MudButton>
                                        <MudButton Color="Color.Secondary"
                                                  Variant="Variant.Outlined"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Edit"
                                                  OnClick="@(() => EditEntry(entry))">
                                            Edit
                                        </MudButton>
                                        <MudButton Color="Color.Default"
                                                  Variant="Variant.Text"
                                                  Size="Size.Small"
                                                  StartIcon="@Icons.Material.Filled.Share"
                                                  OnClick="@(() => Snackbar.Add("Share feature coming soon!", Severity.Info))">
                                            Share
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
            }
            else
            {
                <!-- Empty State -->
                <MudPaper Elevation="2" Class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Start Searching</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Enter keywords to find your journal entries
                    </MudText>
                </MudPaper>
            }

        </MudItem>

        <!-- Sidebar -->
        <MudItem xs="12" md="4">
            <MudStack Spacing="4">

                <!-- Quick Filters -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">‚ö° Quick Filters</MudText>
                    
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Outlined"
                                  FullWidth
                                  StartIcon="@Icons.Material.Filled.Today"
                                  OnClick="@(() => QuickFilter("today"))">
                            Today's Entry
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                  FullWidth
                                  StartIcon="@Icons.Material.Filled.DateRange"
                                  OnClick="@(() => QuickFilter("week"))">
                            This Week
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                  FullWidth
                                  StartIcon="@Icons.Material.Filled.CalendarMonth"
                                  OnClick="@(() => QuickFilter("month"))">
                            This Month
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                  FullWidth
                                  StartIcon="@Icons.Material.Filled.Star"
                                  OnClick="@(() => QuickFilter("favorites"))">
                            Favorites
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Popular Tags -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üè∑Ô∏è Popular Tags</MudText>
                    
                    <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                        @foreach (var tag in GetPopularTags())
                        {
                            <MudChip T="string" Size="Size.Small"
                                    Variant="Variant.Outlined"
                                    Color="Color.Primary"
                                    OnClick="@(() => SearchByTag(tag.Name))">
                                @tag.Name (@tag.Count)
                            </MudChip>
                        }
                    </MudStack>
                </MudPaper>

                <!-- Recent Searches -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üïí Recent Searches</MudText>
                    
                    @if (recentSearches.Any())
                    {
                        <MudList T="string"  Dense Clickable>
                            @foreach (var search in recentSearches.Take(5))
                            {
                                <MudListItem T="string" Icon="@Icons.Material.Filled.History"
                                            OnClick="@(() => { searchQuery = search; PerformSearch(); })">
                                    @search
                                </MudListItem>
                            }
                        </MudList>
                        <MudButton Color="Color.Default"
                                  Variant="Variant.Text"
                                  Size="Size.Small"
                                  FullWidth
                                  OnClick="ClearHistory">
                            Clear History
                        </MudButton>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            No recent searches
                        </MudText>
                    }
                </MudPaper>

                <!-- Search Tips -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">üí° Search Tips</MudText>
                    
                    <MudList T="string" Dense>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Use quotes for exact phrases: "happy moments"
                            </MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Search multiple words: work family balance
                            </MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Info" IconSize="Size.Small">
                            <MudText Typo="Typo.caption">
                                Filter by date range for better results
                            </MudText>
                        </MudListItem>
                    </MudList>
                </MudPaper>

            </MudStack>
        </MudItem>

    </MudGrid>

</MudContainer>

<style>
    .search-result-card {
        transition: all 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .search-result-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .search-result-list {
        transition: all 0.2s;
    }

    .search-result-list:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .search-preview {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        line-height: 1.6;
    }

    .search-preview-list {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        line-height: 1.6;
    }

    .highlight {
        background-color: rgba(255, 235, 59, 0.5);
        font-weight: 600;
        padding: 0 2px;
        border-radius: 2px;
    }
</style>

@code {
    
    /*private string searchQuery = "";
    private DateRange? dateRange = null;
    private string selectedMood = "";
    private string wordCountFilter = "all";
    private string sortBy = "date-desc";
    private string viewMode = "grid";
    
    private bool isSearching = false;
    private bool hasSearched = false;
    private List<SearchResult> searchResults = new();
    private List<string> recentSearches = new() { "gratitude", "work stress", "family time" };

    protected override void OnInitialized()
    {
        if (!AuthService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery) && dateRange == null && string.IsNullOrEmpty(selectedMood))
        {
            Snackbar.Add("Please enter a search term or select filters", Severity.Warning);
            return;
        }

        isSearching = true;
        hasSearched = false;
        StateHasChanged();

        // Simulate search delay
        await Task.Delay(500);

        // TODO: Replace with actual search logic
        searchResults = GetMockSearchResults();

        // Add to recent searches
        if (!string.IsNullOrWhiteSpace(searchQuery) && !recentSearches.Contains(searchQuery))
        {
            recentSearches.Insert(0, searchQuery);
            if (recentSearches.Count > 5) recentSearches.RemoveAt(5);
        }

        isSearching = false;
        hasSearched = true;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchQuery = "";
        dateRange = null;
        selectedMood = "";
        wordCountFilter = "all";
        sortBy = "date-desc";
        hasSearched = false;
        searchResults.Clear();
    }

    private void ClearHistory()
    {
        recentSearches.Clear();
        Snackbar.Add("Search history cleared", Severity.Info);
    }

    private async Task QuickFilter(string filter)
    {
        switch (filter)
        {
            case "today":
                dateRange = new DateRange(DateTime.Today, DateTime.Today);
                break;
            case "week":
                dateRange = new DateRange(DateTime.Today.AddDays(-7), DateTime.Today);
                break;
            case "month":
                dateRange = new DateRange(DateTime.Today.AddMonths(-1), DateTime.Today);
                break;
        }
        await PerformSearch();
    }

    private async Task SearchByTag(string tag)
    {
        searchQuery = tag;
        await PerformSearch();
    }

    private string HighlightText(string text)
    {
        // Simple highlight implementation
        // TODO: Implement proper HTML highlighting
        return text.Length > 200 ? text.Substring(0, 200) + "..." : text;
    }

    private Color GetMoodColor(string mood)
    {
        if (mood.Contains("Happy") || mood.Contains("Grateful")) return Color.Success;
        if (mood.Contains("Sad") || mood.Contains("Frustrated")) return Color.Error;
        if (mood.Contains("Peaceful")) return Color.Info;
        return Color.Default;
    }

    private List<TagData> GetPopularTags()
    {
        return new List<TagData>
        {
            new("gratitude", 24), new("work", 18), new("family", 15),
            new("health", 12), new("goals", 10), new("reflection", 8)
        };
    }

    private List<SearchResult> GetMockSearchResults()
    {
        // TODO: Replace with actual database search
        var random = new Random();
        return Enumerable.Range(1, 8).Select(i => new SearchResult
        {
            Date = DateTime.Today.AddDays(-random.Next(1, 90)),
            Content = "Today was an interesting day filled with many thoughts and reflections. I spent time contemplating my goals and the progress I've made so far this year. There were challenges, but also moments of joy and gratitude.",
            WordCount = random.Next(150, 800),
            Mood = new[] { "üòä Happy", "üòå Peaceful", "ü§ó Grateful" }[random.Next(3)],
            Tags = new List<string> { "gratitude", "reflection", "goals" }
        }).ToList();
    }

    private void ViewEntry(SearchResult entry)
    {
        Snackbar.Add($"Viewing entry from {entry.Date:MMM dd}", Severity.Info);
        // TODO: Navigate to entry detail page
    }

    private void EditEntry(SearchResult entry)
    {
        NavigationManager.NavigateTo($"/journal?date={entry.Date:yyyy-MM-dd}");
    }

    public class SearchResult
    {
        public DateTime Date { get; set; }
        public string Content { get; set; }
        public int WordCount { get; set; }
        public string Mood { get; set; }
        public List<string> Tags { get; set; } = new();
    }

    record TagData(string Name, int Count);
    */
}