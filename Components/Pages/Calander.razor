@page "/calendar"
@using Journal.Services

@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-8">

    @if (!AuthService.IsAuthenticated)
    {
        <MudAlert Severity="Severity.Warning">Please log in to view your calendar.</MudAlert>
        return;
    }

    <!-- Header with Navigation -->
    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <div>
            <MudText Typo="Typo.h3">ðŸ“… Journal Calendar</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @currentDate.ToString("MMMM yyyy")
            </MudText>
        </div>
        
        <MudStack Row Spacing="2">
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                              OnClick="PreviousMonth" 
                              Title="Previous month" />
                <MudButton OnClick="GoToToday">Today</MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                              OnClick="NextMonth" 
                              Title="Next month" />
            </MudButtonGroup>
            
            <MudMenu Icon="@Icons.Material.Filled.ViewModule" 
                    Variant="Variant.Outlined" 
                    Color="Color.Primary"
                    AnchorOrigin="Origin.BottomRight"
                    TransformOrigin="Origin.TopRight">
                <MudMenuItem OnClick="@(() => SetView("month"))">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" />
                        <MudText>Month View</MudText>
                    </MudStack>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => SetView("year"))">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarViewMonth" Size="Size.Small" />
                        <MudText>Year View</MudText>
                    </MudStack>
                </MudMenuItem>
            </MudMenu>
        </MudStack>
    </MudStack>

    <MudGrid Spacing="4">

        <!-- Main Calendar -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="calendar-container">
                
                @if (currentView == "month")
                {
                    <!-- Month View -->
                    <div class="calendar-month">
                        <!-- Day Headers -->
                        <div class="calendar-header">
                            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                            {
                                <div class="calendar-day-header">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@day</MudText>
                                </div>
                            }
                        </div>

                        <!-- Calendar Days -->
                        <div class="calendar-grid">
                            @foreach (var day in GetCalendarDays())
                            {
                                var isToday = day.Date == DateTime.Today;
                                var isCurrentMonth = day.Month == currentDate.Month;
                                var hasEntry = entriesByDate.ContainsKey(day.Date);
                                var entry = hasEntry ? entriesByDate[day.Date] : null;

                                <div class="@GetDayClass(day, isToday, isCurrentMonth, hasEntry)"
                                     @onclick="@(() => OnDayClick(day))">
                                    
                                    <div class="calendar-day-number">
                                        <MudText Typo="Typo.body2" 
                                                Color="@(isToday ? Color.Primary : isCurrentMonth ? Color.Default : Color.Secondary)">
                                            @day.Day
                                        </MudText>
                                    </div>

                                    @if (hasEntry)
                                    {
                                        <div class="calendar-day-content">
                                            <MudChip T="string" Size="Size.Small" 
                                                    Color="@GetMoodColor(entry.Mood)"
                                                    Variant="Variant.Filled"
                                                    Class="entry-chip">
                                                @entry.Mood
                                            </MudChip>
                                            
                                            @if (!string.IsNullOrEmpty(entry.Preview))
                                            {
                                                <MudText Typo="Typo.caption" Class="entry-preview">
                                                    @entry.Preview
                                                </MudText>
                                            }
                                        </div>
                                    }
                                    else if (isCurrentMonth)
                                    {
                                        <div class="calendar-day-empty">
                                            <MudIcon Icon="@Icons.Material.Outlined.Add" 
                                                    Size="Size.Small" 
                                                    Color="Color.Secondary" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <!-- Year View -->
                    <div class="calendar-year">
                        <MudGrid Spacing="3">
                            @for (int month = 1; month <= 12; month++)
                            {
                                var monthDate = new DateTime(currentDate.Year, month, 1);
                                
                                <MudItem xs="6" sm="4" md="3">
                                    <MudPaper Elevation="1" Class="pa-2 mini-calendar">
                                        <MudText Typo="Typo.caption" Align="Align.Center" Class="mb-2">
                                            @monthDate.ToString("MMMM")
                                        </MudText>
                                        
                                        <div class="mini-calendar-grid">
                                            @foreach (var day in GetMiniCalendarDays(monthDate))
                                            {
                                                var hasEntry = entriesByDate.ContainsKey(day);
                                                var isToday = day == DateTime.Today;
                                                
                                                <div class="@GetMiniDayClass(hasEntry, isToday)"
                                                     @onclick="@(() => OnMiniDayClick(day))">
                                                </div>
                                            }
                                        </div>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                }

            </MudPaper>
        </MudItem>

        <!-- Sidebar -->
        <MudItem xs="12" md="4">
            <MudStack Spacing="4">

                <!-- Selected Date Info -->
                @if (selectedDate.HasValue)
                {
                    var hasEntry = entriesByDate.ContainsKey(selectedDate.Value);
                    var entry = hasEntry ? entriesByDate[selectedDate.Value] : null;

                    <MudPaper Elevation="3" Class="pa-4">
                        <MudStack Spacing="3">
                            <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h6">
                                    @selectedDate.Value.ToString("MMMM dd, yyyy")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                              Size="Size.Small"
                                              OnClick="@(() => selectedDate = null)" />
                            </MudStack>

                            @if (hasEntry)
                            {
                                <MudDivider />
                                
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Mood</MudText>
                                    <MudChip T="string" Color="@GetMoodColor(entry.Mood)" 
                                            Variant="Variant.Filled"
                                            Size="Size.Small"
                                            Class="mt-1">
                                        @entry.Mood
                                    </MudChip>
                                </div>

                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Entry Preview</MudText>
                                    <MudText Typo="Typo.body2" Class="mt-1">
                                        @entry.Preview
                                    </MudText>
                                </div>

                                <MudStack Row Spacing="2">
                                    <MudButton Color="Color.Primary"
                                              Variant="Variant.Filled"
                                              StartIcon="@Icons.Material.Filled.Visibility"
                                              Size="Size.Small"
                                              OnClick="@(() => ViewEntry(entry))">
                                        View Full Entry
                                    </MudButton>
                                    <MudButton Color="Color.Secondary"
                                              Variant="Variant.Outlined"
                                              StartIcon="@Icons.Material.Filled.Edit"
                                              Size="Size.Small"
                                              OnClick="@(() => EditEntry(entry))">
                                        Edit
                                    </MudButton>
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense>
                                    No entry for this date
                                </MudAlert>
                                
                                <MudButton Color="Color.Primary"
                                          Variant="Variant.Filled"
                                          FullWidth
                                          StartIcon="@Icons.Material.Filled.Add"
                                          OnClick="@(() => CreateEntry(selectedDate.Value))">
                                    Write Entry
                                </MudButton>
                            }
                        </MudStack>
                    </MudPaper>
                }

                <!-- Quick Stats -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">This Month</MudText>
                    
                    <MudStack Spacing="2">
                        <MudStack Row Spacing="2" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2">Entries written</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                @GetMonthEntryCount()
                            </MudChip>
                        </MudStack>
                        
                        <MudStack Row Spacing="2" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2">Current streak</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                7 days ðŸ”¥
                            </MudChip>
                        </MudStack>

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.caption" Color="Color.Secondary">Most common mood</MudText>
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">ðŸ˜Š Happy</MudChip>
                    </MudStack>
                </MudPaper>

                <!-- Legend -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Legend</MudText>
                    
                    <MudStack Spacing="2">
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-today"></div>
                            <MudText Typo="Typo.body2">Today</MudText>
                        </MudStack>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-entry"></div>
                            <MudText Typo="Typo.body2">Has entry</MudText>
                        </MudStack>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-empty"></div>
                            <MudText Typo="Typo.body2">No entry</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>

            </MudStack>
        </MudItem>

    </MudGrid>

</MudContainer>

<style>
    .calendar-container {
        padding: 1.5rem;
        min-height: 600px;
    }

    /* Month View */
    .calendar-month {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--mud-palette-divider);
    }

    .calendar-day-header {
        text-align: center;
        padding: 0.5rem;
        font-weight: 600;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }

    .calendar-day {
        min-height: 100px;
        padding: 0.75rem;
        border-radius: 8px;
        border: 2px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
    }

    .calendar-day:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: var(--mud-palette-primary);
    }

    .calendar-day-other-month {
        opacity: 0.3;
    }

    .calendar-day-today {
        border-color: var(--mud-palette-primary);
        background: rgba(33, 150, 243, 0.05);
    }

    .calendar-day-has-entry {
        border-color: var(--mud-palette-success);
        background: rgba(76, 175, 80, 0.05);
    }

    .calendar-day-number {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .calendar-day-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
    }

    .calendar-day-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .calendar-day:hover .calendar-day-empty {
        opacity: 0.5;
    }

    .entry-chip {
        width: fit-content;
    }

    .entry-preview {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
    }

    /* Year View */
    .calendar-year {
        padding: 1rem;
    }

    .mini-calendar {
        cursor: pointer;
        transition: all 0.2s;
    }

    .mini-calendar:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .mini-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }

    .mini-day {
        aspect-ratio: 1;
        border-radius: 2px;
        background: var(--mud-palette-background-grey);
        cursor: pointer;
        transition: all 0.2s;
    }

    .mini-day-entry {
        background: var(--mud-palette-success);
    }

    .mini-day-today {
        outline: 2px solid var(--mud-palette-primary);
        outline-offset: -2px;
    }

    .mini-day:hover {
        transform: scale(1.2);
    }

    /* Legend */
    .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 2px solid;
    }

    .legend-today {
        border-color: var(--mud-palette-primary);
        background: rgba(33, 150, 243, 0.1);
    }

    .legend-entry {
        border-color: var(--mud-palette-success);
        background: rgba(76, 175, 80, 0.1);
    }

    .legend-empty {
        border-color: var(--mud-palette-divider);
        background: var(--mud-palette-surface);
    }

    /* Responsive */
    @@media (max-width: 960px) {
        .calendar-day {
            min-height: 80px;
            padding: 0.5rem;
        }

        .entry-preview {
            display: none;
        }
    }
</style>

@code {
    private DateTime currentDate = DateTime.Today;
    private DateTime? selectedDate = null;
    private string currentView = "month";
    private Dictionary<DateTime, JournalEntryPreview> entriesByDate = new();

    protected override void OnInitialized()
    {
        if (!AuthService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        LoadEntries();
    }

    private void LoadEntries()
    {
        // TODO: Load actual entries from database
        // Mock data for demonstration
        var random = new Random(42);
        var moods = new[] { "ðŸ˜Š Happy", "ðŸ˜” Sad", "ðŸ˜Œ Peaceful", "ðŸ˜¤ Frustrated", "ðŸ¤— Grateful" };
        
        for (int i = 0; i < 60; i++)
        {
            var date = DateTime.Today.AddDays(-random.Next(0, 90));
            if (!entriesByDate.ContainsKey(date))
            {
                entriesByDate[date] = new JournalEntryPreview
                {
                    Date = date,
                    Mood = moods[random.Next(moods.Length)],
                    Preview = "Today was an interesting day with many thoughts to reflect upon..."
                };
            }
        }
    }

    private List<DateTime> GetCalendarDays()
    {
        var firstDay = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        
        var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);
        var endDate = lastDay.AddDays(6 - (int)lastDay.DayOfWeek);
        
        var days = new List<DateTime>();
        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            days.Add(date);
        }
        return days;
    }

    private List<DateTime> GetMiniCalendarDays(DateTime month)
    {
        var firstDay = new DateTime(month.Year, month.Month, 1);
        var daysInMonth = DateTime.DaysInMonth(month.Year, month.Month);
        
        var days = new List<DateTime>();
        for (int i = 1; i <= daysInMonth; i++)
        {
            days.Add(new DateTime(month.Year, month.Month, i));
        }
        return days;
    }

    private string GetDayClass(DateTime day, bool isToday, bool isCurrentMonth, bool hasEntry)
    {
        var classes = new List<string> { "calendar-day" };
        
        if (isToday) classes.Add("calendar-day-today");
        if (!isCurrentMonth) classes.Add("calendar-day-other-month");
        if (hasEntry) classes.Add("calendar-day-has-entry");
        
        return string.Join(" ", classes);
    }

    private string GetMiniDayClass(bool hasEntry, bool isToday)
    {
        var classes = new List<string> { "mini-day" };
        if (hasEntry) classes.Add("mini-day-entry");
        if (isToday) classes.Add("mini-day-today");
        return string.Join(" ", classes);
    }

    private Color GetMoodColor(string mood)
    {
        if (mood.Contains("Happy") || mood.Contains("Grateful")) return Color.Success;
        if (mood.Contains("Sad") || mood.Contains("Frustrated")) return Color.Error;
        if (mood.Contains("Peaceful")) return Color.Info;
        return Color.Default;
    }

    private void PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
    }

    private void NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
    }

    private void GoToToday()
    {
        currentDate = DateTime.Today;
        selectedDate = DateTime.Today;
    }

    private void SetView(string view)
    {
        currentView = view;
        if (view == "year")
        {
            currentDate = new DateTime(DateTime.Today.Year, 1, 1);
        }
    }

    private void OnDayClick(DateTime day)
    {
        selectedDate = day;
    }

    private void OnMiniDayClick(DateTime day)
    {
        currentDate = day;
        selectedDate = day;
        currentView = "month";
    }

    private int GetMonthEntryCount()
    {
        return entriesByDate.Values.Count(e => 
            e.Date.Year == currentDate.Year && 
            e.Date.Month == currentDate.Month);
    }

    private void ViewEntry(JournalEntryPreview entry)
    {
        Snackbar.Add($"Viewing entry from {entry.Date:MMM dd}", Severity.Info);
        // TODO: Navigate to entry detail page or show dialog
    }

    private void EditEntry(JournalEntryPreview entry)
    {
        Snackbar.Add($"Editing entry from {entry.Date:MMM dd}", Severity.Info);
        // TODO: Navigate to edit page
    }

    private void CreateEntry(DateTime date)
    {
        NavigationManager.NavigateTo($"/journal?date={date:yyyy-MM-dd}");
    }

    public class JournalEntryPreview
    {
        public DateTime Date { get; set; }
        public string Mood { get; set; }
        public string Preview { get; set; }
    }
}