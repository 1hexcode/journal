@page "/calendar"
@using Journal.Repository
@using Journal.Services

@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject JournalRepository JournalRepository

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-8">

    @if (!AuthService.IsAuthenticated)
    {
        <MudAlert Severity="Severity.Warning">Please log in to view your calendar.</MudAlert>
        return;
    }

    <!-- Header with Navigation -->
    <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <div>
            <MudText Typo="Typo.h3">ðŸ“… Journal Calendar</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @currentDate.ToString("MMMM yyyy")
            </MudText>
        </div>
        
        <MudStack Row Spacing="2">
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                              OnClick="PreviousMonth" 
                              Title="Previous month" />
                <MudButton OnClick="GoToToday">Today</MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                              OnClick="NextMonth" 
                              Title="Next month" />
            </MudButtonGroup>
            
            <MudMenu Icon="@Icons.Material.Filled.ViewModule" 
                    Variant="Variant.Outlined" 
                    Color="Color.Primary"
                    AnchorOrigin="Origin.BottomRight"
                    TransformOrigin="Origin.TopRight">
                <MudMenuItem OnClick="@(() => SetView("month"))">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" />
                        <MudText>Month View</MudText>
                    </MudStack>
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => SetView("year"))">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarViewMonth" Size="Size.Small" />
                        <MudText>Year View</MudText>
                    </MudStack>
                </MudMenuItem>
            </MudMenu>
        </MudStack>
    </MudStack>

    <MudGrid Spacing="4">

        <!-- Main Calendar -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="calendar-container">
                
                @if (currentView == "month")
                {
                    <!-- Month View -->
                    <div class="calendar-month">
                        <!-- Day Headers -->
                        <div class="calendar-header">
                            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                            {
                                <div class="calendar-day-header">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@day</MudText>
                                </div>
                            }
                        </div>

                        <!-- Calendar Days -->
                        <div class="calendar-grid">
                            @foreach (var day in GetCalendarDays())
                            {
                                var isToday = day.Date == DateTime.Today;
                                var isCurrentMonth = day.Month == currentDate.Month;
                                var hasEntry = entriesByDate.ContainsKey(day.Date);
                                var entry = hasEntry ? entriesByDate[day.Date] : null;

                                <div class="@GetDayClass(day, isToday, isCurrentMonth, hasEntry)"
                                     @onclick="@(() => OnDayClick(day))">
                                    
                                    <div class="calendar-day-number">
                                        <MudText Typo="Typo.body2" 
                                                Color="@(isToday ? Color.Primary : isCurrentMonth ? Color.Default : Color.Secondary)">
                                            @day.Day
                                        </MudText>
                                    </div>

                                    @if (hasEntry)
                                    {
                                        <div class="calendar-day-content">
                                            <MudChip T="string" Size="Size.Small" 
                                                    Color="@GetMoodColor(entry.Mood)"
                                                    Variant="Variant.Filled"
                                                    Class="entry-chip">
                                                @GetMoodEmoji(entry.Mood) @entry.Mood
                                            </MudChip>
                                        </div>
                                    }
                                    else if (isCurrentMonth)
                                    {
                                        <div class="calendar-day-empty">
                                            <MudIcon Icon="@Icons.Material.Outlined.Add" 
                                                    Size="Size.Small" 
                                                    Color="Color.Secondary" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <!-- Year View -->
                    <div class="calendar-year">
                        <MudGrid Spacing="3">
                            @for (int month = 1; month <= 12; month++)
                            {
                                var monthDate = new DateTime(currentDate.Year, month, 1);
                                
                                <MudItem xs="6" sm="4" md="3">
                                    <MudPaper Elevation="1" Class="pa-2 mini-calendar">
                                        <MudText Typo="Typo.caption" Align="Align.Center" Class="mb-2">
                                            @monthDate.ToString("MMMM")
                                        </MudText>
                                        
                                        <div class="mini-calendar-grid">
                                            @foreach (var day in GetMiniCalendarDays(monthDate))
                                            {
                                                var hasEntry = entriesByDate.ContainsKey(day);
                                                var isToday = day == DateTime.Today;
                                                
                                                <div class="@GetMiniDayClass(hasEntry, isToday)"
                                                     @onclick="@(() => OnMiniDayClick(day))">
                                                </div>
                                            }
                                        </div>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                }

            </MudPaper>
        </MudItem>

        <!-- Sidebar -->
        <MudItem xs="12" md="4">
            <MudStack Spacing="4">

                <!-- Selected Date Info -->
                @if (selectedDate.HasValue)
                {
                    var hasEntry = entriesByDate.ContainsKey(selectedDate.Value);
                    var entry = hasEntry ? entriesByDate[selectedDate.Value] : null;

                    <MudPaper Elevation="3" Class="pa-4">
                        <MudStack Spacing="3">
                            <MudStack Row Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h6">
                                    @selectedDate.Value.ToString("MMMM dd, yyyy")
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                              Size="Size.Small"
                                              OnClick="@(() => selectedDate = null)" />
                            </MudStack>

                            @if (hasEntry)
                            {
                                <MudDivider />
                                
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Mood</MudText>
                                    <MudChip T="string" Color="@GetMoodColor(entry.Mood)" 
                                            Variant="Variant.Filled"
                                            Size="Size.Small"
                                            Class="mt-1">
                                        @entry.Mood
                                    </MudChip>
                                </div>

                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Entry Preview</MudText>
                                    <MudText Typo="Typo.body2" Class="mt-1">
                                        @entry.Preview
                                    </MudText>
                                </div>

                                <MudStack Row Spacing="2">
                                    <MudButton Color="Color.Primary"
                                              Variant="Variant.Filled"
                                              StartIcon="@Icons.Material.Filled.Visibility"
                                              Size="Size.Small"
                                              OnClick="@(() => ViewEntry(entry))">
                                        View Full Entry
                                    </MudButton>
                                    <MudButton Color="Color.Secondary"
                                              Variant="Variant.Outlined"
                                              StartIcon="@Icons.Material.Filled.Edit"
                                              Size="Size.Small"
                                              OnClick="@(() => EditEntry(entry))">
                                        Edit
                                    </MudButton>
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense>
                                    No entry for this date
                                </MudAlert>
                                
                                <MudButton Color="Color.Primary"
                                          Variant="Variant.Filled"
                                          FullWidth
                                          StartIcon="@Icons.Material.Filled.Add"
                                          OnClick="@(() => CreateEntry(selectedDate.Value))">
                                    Write Entry
                                </MudButton>
                            }
                        </MudStack>
                    </MudPaper>
                }

                <!-- Quick Stats -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">This Month</MudText>
                    
                    <MudStack Spacing="2">
                        <MudStack Row Spacing="2" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2">Entries written</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                @GetMonthEntryCount()
                            </MudChip>
                        </MudStack>
                        
                        <MudStack Row Spacing="2" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2">Current streak</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                7 days ðŸ”¥
                            </MudChip>
                        </MudStack>

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.caption" Color="Color.Secondary">Most common mood</MudText>
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">ðŸ˜Š Happy</MudChip>
                    </MudStack>
                </MudPaper>

                <!-- Legend -->
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Legend</MudText>
                    
                    <MudStack Spacing="2">
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-today"></div>
                            <MudText Typo="Typo.body2">Today</MudText>
                        </MudStack>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-entry"></div>
                            <MudText Typo="Typo.body2">Has entry</MudText>
                        </MudStack>
                        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                            <div class="legend-box legend-empty"></div>
                            <MudText Typo="Typo.body2">No entry</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>

            </MudStack>
        </MudItem>

    </MudGrid>

</MudContainer>

@code {
    
}