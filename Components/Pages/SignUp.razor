@attribute [Route(SignUp.Route)]

@layout EmptyLayout

@using System.ComponentModel.DataAnnotations

<MudContainer MaxWidth="MaxWidth.False"
              Class="d-flex align-center justify-center"
              Style="height:100vh;">
    
    <MudPaper Elevation="3" Class="pa-8" Style="max-width:500px; width:100%;">

        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom>
            Create Account
        </MudText>

        <EditForm Model="@model" OnValidSubmit="HandleSignup">
            <DataAnnotationsValidator/>
            <MudStack Spacing="3">
                <MudTextField @bind-Value="model.FirstName"
                              Label="First Name"
                              Variant="Variant.Outlined"
                              For="@(() => model.FirstName)"
                              FullWidth
                              Margin="Margin.Dense"/>

                <MudTextField @bind-Value="model.LastName"
                              Label="Last Name"
                              Variant="Variant.Outlined"
                              For="@(() => model.LastName)"
                              FullWidth
                              Margin="Margin.Dense"/>

                <MudTextField @bind-Value="model.Username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              For="@(() => model.Username)"
                              FullWidth
                              Margin="Margin.Dense"/>

                <MudTextField @bind-Value="model.Email"
                              Label="Email"
                              InputType="InputType.Email"
                              Variant="Variant.Outlined"
                              For="@(() => model.Email)"
                              FullWidth
                              Margin="Margin.Dense"/>

                <MudTextField @bind-Value="model.Password"
                              Label="Password"
                              InputType="@PasswordInput"
                              Variant="Variant.Outlined"
                              For="@(() => model.Password)"
                              FullWidth
                              Margin="Margin.Dense"
                              Adornment="Adornment.End"
                              AdornmentIcon="@PasswordInputIcon"
                              OnAdornmentClick="TogglePasswordVisibility"/>

                <MudTextField @bind-Value="model.ConfirmPassword"
                              Label="Confirm Password"
                              InputType="@ConfirmPasswordInput"
                              Variant="Variant.Outlined"
                              For="@(() => model.ConfirmPassword)"
                              FullWidth
                              Margin="Margin.Dense"
                              Adornment="Adornment.End"
                              AdornmentIcon="@ConfirmPasswordInputIcon"
                              OnAdornmentClick="ToggleConfirmPasswordVisibility"/>

                <MudCheckBox @bind-Value="model.AcceptTerms" Color="Color.Primary" Class="mt-2">
                    I agree to the terms & conditions
                </MudCheckBox>

                <MudButton Type="Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth
                           Size="Size.Large"
                           Class="mt-4">
                    Create Account
                </MudButton>
            </MudStack>
        </EditForm>
        <MudStack Row="true" Justify="Justify.Center" Spacing="1" Class="mt-4">
            <MudText Typo="Typo.body2">
                Already have an account?
            </MudText>

            <MudLink Href="/login" Typo="Typo.body2" Color="Color.Primary">
                Sign in
            </MudLink>
        </MudStack>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@errorMessage</MudAlert>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <MudAlert Severity="Severity.Success" Class="mt-3">@successMessage</MudAlert>
        }

    </MudPaper>
</MudContainer>

@code {
    private SignupModel model = new();
    private bool isPasswordVisible;
    private bool isConfirmPasswordVisible;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private InputType PasswordInput => isPasswordVisible ? InputType.Text : InputType.Password;
    private string PasswordInputIcon => isPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private InputType ConfirmPasswordInput => isConfirmPasswordVisible ? InputType.Text : InputType.Password;
    private string ConfirmPasswordInputIcon => isConfirmPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        isConfirmPasswordVisible = !isConfirmPasswordVisible;
    }

    private async Task HandleSignup()
    {
        try
        {
            errorMessage = string.Empty;
            successMessage = string.Empty;

            // Implement your registration logic here
            // Example:
            // var result = await AuthService.RegisterAsync(model.FullName, model.Email, model.Password);
            // if (result.Success)
            // {
            //     successMessage = "Account created successfully! Redirecting...";
            //     await Task.Delay(2000);
            //     NavigationManager.NavigateTo("/login");
            // }

            // For demo purposes
            await Task.Delay(500);
            successMessage = "Account created successfully!";
            // NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during registration. Please try again.";
        }
    }

    public class SignupModel : IValidatableObject
    {
        [Required, MinLength(2)]
        public string FirstName { get; set; } = string.Empty;

        [Required, MinLength(2)]
        public string LastName { get; set; } = string.Empty;

        [Required, MinLength(3)]
        public string Username { get; set; } = string.Empty;

        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(8)]
        public string Password { get; set; } = string.Empty;

        [Required]
        public string ConfirmPassword { get; set; } = string.Empty;

        [Range(typeof(bool), "true", "true")]
        public bool AcceptTerms { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext context)
        {
            if (Password != ConfirmPassword)
            {
                yield return new ValidationResult(
                    "Passwords do not match",
                    new[] { nameof(ConfirmPassword) });
            }
        }
    }
}