@page "/journal"
@using System.ComponentModel.DataAnnotations

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudGrid>
        <!-- Left Sidebar - Calendar & Entry List -->
        <MudItem xs="12" md="4" lg="3">
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">Select Date</MudText>
                <MudDatePicker @bind-Date="selectedDate"
                               Editable="false"
                               MaxDate="DateTime.Today"
                               Color="Color.Primary"
                               DateFormat="dd/MM/yyyy"
                               FirstDayOfWeek="DayOfWeek.Sunday" />
            </MudPaper>

            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Recent Entries</MudText>
                <MudList Clickable="true" Dense="true" T="string">
                    @foreach (var entry in recentEntries)
                    {
                        <MudListItem OnClick="@(() => LoadEntry(entry))"
                                     Class="@(currentEntry?.Id == entry.Id ? "mud-primary-text" : "")"
                                     T="string">
                            <MudStack Row="false" Spacing="0">
                                <MudText Typo="Typo.body2" Class="font-weight-bold">
                                    @entry.EntryDate.ToString("MMM dd, yyyy")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @GetEntryPreview(entry.Content)
                                </MudText>
                            </MudStack>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudPaper>
        </MudItem>

        <!-- Main Content - Journal Editor -->
        <MudItem xs="12" md="8" lg="9">
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h5">
                        @(isEditMode ? "Edit" : "New") Journal Entry
                    </MudText>
                    <MudStack Row="true" Spacing="2">
                        <MudIconButton Icon="@Icons.Material.Filled.FormatBold" 
                                       Title="Bold"
                                       OnClick="@(() => InsertMarkdown("**", "**"))"
                                       Color="Color.Default" />
                        <MudIconButton Icon="@Icons.Material.Filled.FormatItalic" 
                                       Title="Italic"
                                       OnClick="@(() => InsertMarkdown("*", "*"))"
                                       Color="Color.Default" />
                        <MudIconButton Icon="@Icons.Material.Filled.FormatListBulleted" 
                                       Title="Bullet List"
                                       OnClick="@(() => InsertMarkdown("- ", ""))"
                                       Color="Color.Default" />
                        <MudIconButton Icon="@Icons.Material.Filled.FormatListNumbered" 
                                       Title="Numbered List"
                                       OnClick="@(() => InsertMarkdown("1. ", ""))"
                                       Color="Color.Default" />
                        <MudDivider Vertical="true" FlexItem="true" />
                        <MudToggleIconButton @bind-Toggled="@showPreview"
                                             Icon="@Icons.Material.Filled.Visibility"
                                             ToggledIcon="@Icons.Material.Filled.Edit"
                                             Title="@(showPreview ? "Edit Mode" : "Preview Mode")"
                                             Color="Color.Primary" />
                    </MudStack>
                </MudStack>

                <EditForm Model="@currentEntry" OnValidSubmit="SaveEntry">
                    <DataAnnotationsValidator />

                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="currentEntry.Title"
                                          Label="Title"
                                          Variant="Variant.Outlined"
                                          For="@(() => currentEntry.Title)"
                                          FullWidth="true"
                                          Immediate="true" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField Value="@selectedDate?.ToString("MMMM dd, yyyy")"
                                          Label="Entry Date"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          FullWidth="true" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField Value="@GetTimestampInfo()"
                                          Label="Status"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          FullWidth="true" />
                        </MudItem>

                        <MudItem xs="12">
                            @if (!showPreview)
                            {
                                <MudTextField @bind-Value="currentEntry.Content"
                                              Label="Content (Markdown supported)"
                                              Variant="Variant.Outlined"
                                              For="@(() => currentEntry.Content)"
                                              Lines="15"
                                              FullWidth="true"
                                              Immediate="true"
                                              @ref="contentField" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Supports Markdown: **bold**, *italic*, # heading, - list, etc.
                                </MudText>
                            }
                            else
                            {
                                <MudPaper Elevation="0" Class="pa-4" Style="min-height: 400px; border: 1px solid #e0e0e0;">
                                    <MudText Typo="Typo.h6" Class="mb-3">Preview</MudText>
                                    <MudDivider Class="mb-3" />
                                    <div class="markdown-preview">
                                        @((MarkupString)RenderMarkdown(currentEntry.Content))
                                    </div>
                                </MudPaper>
                            }
                        </MudItem>

                        <MudItem xs="12">
                            <MudStack Row="true" Spacing="2">
                                <MudButton ButtonType="ButtonType.Submit"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           Disabled="@isSaving">
                                    @(isSaving ? "Saving..." : "Save Entry")
                                </MudButton>

                                @if (isEditMode)
                                {
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               OnClick="ShowDeleteDialog">
                                        Delete
                                    </MudButton>
                                }

                                <MudButton Variant="Variant.Text"
                                           Color="Color.Default"
                                           OnClick="ClearForm">
                                    Clear
                                </MudButton>

                                <MudSpacer />

                                <MudText Typo="Typo.caption" Color="Color.Secondary" AlignSelf="AlignSelf.Center">
                                    @GetWordCount() words
                                </MudText>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<!-- Delete Confirmation Dialog -->
<MudDialog IsVisible="showDeleteDialog">
    <DialogContent>
        <MudText>Are you sure you want to delete this journal entry?</MudText>
        <MudText Typo="Typo.body2" Color="Color.Error" Class="mt-2">
            This action cannot be undone.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showDeleteDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="DeleteEntry">Delete</MudButton>
    </DialogActions>
</MudDialog>

<!-- Success/Error Snackbar -->
@if (!string.IsNullOrEmpty(snackbarMessage))
{
    <MudSnackbar IsVisible="showSnackbar" 
                 Severity="@snackbarSeverity"
                 ShowCloseIcon="true">
        @snackbarMessage
    </MudSnackbar>
}

@code {
    private DateTime? selectedDate = DateTime.Today;
    private JournalEntry currentEntry = new();
    private List<JournalEntry> recentEntries = new();
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool showPreview = false;
    private bool showDeleteDialog = false;
    private bool showSnackbar = false;
    private string snackbarMessage = string.Empty;
    private Severity snackbarSeverity = Severity.Success;
    private MudTextField<string> contentField;

    protected override async Task OnInitializedAsync()
    {
        // Load existing entries from database/storage
        await LoadRecentEntries();
        await LoadEntryForDate(selectedDate.Value);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StateHasChanged();
        }
    }

    private async Task OnDateChanged(DateTime? date)
    {
        if (date.HasValue && date.Value.Date != selectedDate?.Date)
        {
            selectedDate = date;
            await LoadEntryForDate(date.Value);
            StateHasChanged();
        }
    }

    private async Task LoadEntryForDate(DateTime date)
    {
        // Check if entry exists for this date
        var existingEntry = recentEntries.FirstOrDefault(e => e.EntryDate.Date == date.Date);

        if (existingEntry != null)
        {
            currentEntry = new JournalEntry
            {
                Id = existingEntry.Id,
                Title = existingEntry.Title,
                Content = existingEntry.Content,
                EntryDate = existingEntry.EntryDate,
                CreatedAt = existingEntry.CreatedAt,
                UpdatedAt = existingEntry.UpdatedAt
            };
            isEditMode = true;
        }
        else
        {
            currentEntry = new JournalEntry
            {
                EntryDate = date
            };
            isEditMode = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadRecentEntries()
    {
        // TODO: Load from your database/storage service
        // Example data for demonstration
        recentEntries = new List<JournalEntry>
        {
            new JournalEntry
            {
                Id = 1,
                Title = "A Productive Day",
                Content = "Today was incredibly productive. I managed to complete all my tasks and even had time for a walk in the park.",
                EntryDate = DateTime.Today.AddDays(-1),
                CreatedAt = DateTime.Today.AddDays(-1),
                UpdatedAt = DateTime.Today.AddDays(-1)
            },
            new JournalEntry
            {
                Id = 2,
                Title = "Reflection on the Week",
                Content = "This week has been full of challenges but also growth. I learned a lot about myself.",
                EntryDate = DateTime.Today.AddDays(-2),
                CreatedAt = DateTime.Today.AddDays(-2),
                UpdatedAt = DateTime.Today.AddDays(-2)
            }
        };
    }

    private void LoadEntry(JournalEntry entry)
    {
        selectedDate = entry.EntryDate;
        currentEntry = new JournalEntry
        {
            Id = entry.Id,
            Title = entry.Title,
            Content = entry.Content,
            EntryDate = entry.EntryDate,
            CreatedAt = entry.CreatedAt,
            UpdatedAt = entry.UpdatedAt
        };
        isEditMode = true;
    }

    private async Task SaveEntry()
    {
        isSaving = true;

        try
        {
            // Check if entry already exists for this date
            var existingEntry = recentEntries.FirstOrDefault(e => 
                e.EntryDate.Date == currentEntry.EntryDate.Date && e.Id != currentEntry.Id);

            if (existingEntry != null && currentEntry.Id == 0)
            {
                ShowSnackbar("An entry already exists for this date. Please edit the existing entry.", Severity.Warning);
                isSaving = false;
                return;
            }

            if (isEditMode)
            {
                currentEntry.UpdatedAt = DateTime.Now;
                // TODO: Update in database
                var entryToUpdate = recentEntries.FirstOrDefault(e => e.Id == currentEntry.Id);
                if (entryToUpdate != null)
                {
                    entryToUpdate.Title = currentEntry.Title;
                    entryToUpdate.Content = currentEntry.Content;
                    entryToUpdate.UpdatedAt = currentEntry.UpdatedAt;
                }
                ShowSnackbar("Entry updated successfully!", Severity.Success);
            }
            else
            {
                currentEntry.Id = recentEntries.Any() ? recentEntries.Max(e => e.Id) + 1 : 1;
                currentEntry.CreatedAt = DateTime.Now;
                currentEntry.UpdatedAt = DateTime.Now;
                // TODO: Save to database
                recentEntries.Insert(0, new JournalEntry
                {
                    Id = currentEntry.Id,
                    Title = currentEntry.Title,
                    Content = currentEntry.Content,
                    EntryDate = currentEntry.EntryDate,
                    CreatedAt = currentEntry.CreatedAt,
                    UpdatedAt = currentEntry.UpdatedAt
                });
                isEditMode = true;
                ShowSnackbar("Entry saved successfully!", Severity.Success);
            }

            recentEntries = recentEntries.OrderByDescending(e => e.EntryDate).ToList();
        }
        catch (Exception ex)
        {
            ShowSnackbar("Failed to save entry. Please try again.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ShowDeleteDialog()
    {
        showDeleteDialog = true;
    }

    private async Task DeleteEntry()
    {
        try
        {
            // TODO: Delete from database
            recentEntries.RemoveAll(e => e.Id == currentEntry.Id);
            showDeleteDialog = false;
            ClearForm();
            ShowSnackbar("Entry deleted successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            ShowSnackbar("Failed to delete entry. Please try again.", Severity.Error);
        }
    }

    private void ClearForm()
    {
        currentEntry = new JournalEntry
        {
            EntryDate = selectedDate ?? DateTime.Today
        };
        isEditMode = false;
    }

    private void InsertMarkdown(string prefix, string suffix)
    {
        // This is a simplified version - you may want to implement proper cursor position handling
        if (!string.IsNullOrEmpty(currentEntry.Content))
        {
            currentEntry.Content += $"\n{prefix}text{suffix}";
        }
        else
        {
            currentEntry.Content = $"{prefix}text{suffix}";
        }
    }

    private string RenderMarkdown(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "<p class='text-muted'>No content to preview</p>";

        // Basic Markdown rendering (you may want to use a library like Markdig for full support)
        var html = content
            .Replace("&", "&amp;")
            .Replace("<", "&lt;")
            .Replace(">", "&gt;")
            .Replace("\n\n", "</p><p>")
            .Replace("\n", "<br>");

        // Bold
        html = System.Text.RegularExpressions.Regex.Replace(html, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        // Italic
        html = System.Text.RegularExpressions.Regex.Replace(html, @"\*(.*?)\*", "<em>$1</em>");
        // Headings
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^### (.*?)$", "<h3>$1</h3>", System.Text.RegularExpressions.RegexOptions.Multiline);
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^## (.*?)$", "<h2>$1</h2>", System.Text.RegularExpressions.RegexOptions.Multiline);
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^# (.*?)$", "<h1>$1</h1>", System.Text.RegularExpressions.RegexOptions.Multiline);
        // Bullet lists
        html = System.Text.RegularExpressions.Regex.Replace(html, @"^- (.*?)$", "<li>$1</li>", System.Text.RegularExpressions.RegexOptions.Multiline);
        html = System.Text.RegularExpressions.Regex.Replace(html, @"(<li>.*?</li>)", "<ul>$1</ul>");

        return $"<p>{html}</p>";
    }

    private string GetEntryPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "No content";

        var preview = content.Length > 50 ? content.Substring(0, 50) + "..." : content;
        return preview.Replace("\n", " ");
    }

    private string GetTimestampInfo()
    {
        if (currentEntry.CreatedAt == default)
            return "New Entry";

        if (currentEntry.UpdatedAt > currentEntry.CreatedAt)
            return $"Updated {GetRelativeTime(currentEntry.UpdatedAt)}";

        return $"Created {GetRelativeTime(currentEntry.CreatedAt)}";
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";

        return dateTime.ToString("MMM dd, yyyy");
    }

    private int GetWordCount()
    {
        if (string.IsNullOrWhiteSpace(currentEntry.Content))
            return 0;

        return currentEntry.Content.Split(new[] { ' ', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private void ShowSnackbar(string message, Severity severity)
    {
        snackbarMessage = message;
        snackbarSeverity = severity;
        showSnackbar = true;
    }

    public class JournalEntry : IValidatableObject
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "Title is required")]
        [MaxLength(200, ErrorMessage = "Title cannot exceed 200 characters")]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "Content is required")]
        [MinLength(10, ErrorMessage = "Content must be at least 10 characters")]
        public string Content { get; set; } = string.Empty;

        public DateTime EntryDate { get; set; } = DateTime.Today;
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (EntryDate > DateTime.Today)
            {
                yield return new ValidationResult(
                    "Cannot create entries for future dates",
                    new[] { nameof(EntryDate) });
            }
        }
    }
}