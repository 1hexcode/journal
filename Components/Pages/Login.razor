@attribute [Route(Login.Route)]

@using System.ComponentModel.DataAnnotations
@using Journal.Services
@layout EmptyLayout

@inject NavigationManager NavigationManager
@inject AuthService AuthService
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.False"
              Class="d-flex align-center justify-center"
              Style="height:100vh;">
    
    <MudPaper Elevation="3" Class="pa-8"  Style="max-width:500px; width:100%;">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            Welcome Back
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6">
            Sign in to track your mood
        </MudText>

        <EditForm Model="@model" OnSubmit="HandleLogin">
            <DataAnnotationsValidator/>
            <ValidationSummary></ValidationSummary>

            <MudTextField @bind-Value="email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          For="@(() => model.Email)"
                          FullWidth="true"
                          Margin="Margin.Dense"
                          Class="mb-4"/>

            <MudTextField @bind-Value="password"
                          Label="Password"
                          Variant="Variant.Outlined"
                          InputType="@PasswordInput"
                          For="@(() => model.Password)"
                          FullWidth="true"
                          Margin="Margin.Dense"
                          Adornment="Adornment.End"
                          AdornmentIcon="@PasswordInputIcon"
                          OnAdornmentClick="TogglePasswordVisibility"
                          Class="mb-4"/>

            <MudCheckBox @bind-Value="model.RememberMe"
                         Label="Remember me"
                         Color="Color.Primary"
                         Class="mb-4"/>

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       Class="mb-4">
                Sign In
            </MudButton>

            <MudDivider Class="my-4"/>

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudLink Href="/forgot-password" Typo="Typo.body2">
                    Forgot password?
                </MudLink>
                <MudLink Href="/signup" Typo="Typo.body2">
                    Create account
                </MudLink>
            </MudStack>
        </EditForm>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">
                @errorMessage
            </MudAlert>
        }
        @message
    </MudPaper>
</MudContainer>

@code {
    string message = "";
    private LoginModel model = new();
    private bool isPasswordVisible;
    private string errorMessage = string.Empty;
    private string email = "";
    private string password = "";
    
    private InputType PasswordInput => isPasswordVisible ? InputType.Text : InputType.Password;
    private string PasswordInputIcon => isPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    
    // Preferences.Set("username", "user");

     /*protected override void OnInitialized()
    {
        base.OnInitialized();

        string username = Preferences.Get("username", "");
        if (username == "")
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            NavigationManager.NavigateTo("/home");
        }
    }
    */
    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }

    private async Task HandleLogin()
    {
        Console.WriteLine($"Attempting login with: {email} / {password}");

        message = "handle login";
        bool success = await AuthService.Login(email, password);
        
        if (success)
        {
            NavigationManager.NavigateTo("/journal");
        }
        else
        {
            // Show error message
            Snackbar.Add($"{success} Invalid email or password", Severity.Error);
        }
    }

    public class LoginModel
    {
        // [Required(ErrorMessage = "Email is required")]
        // [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        // [Required(ErrorMessage = "Password is required")]
        //[MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }
}